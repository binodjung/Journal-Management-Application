@inherits LayoutComponentBase
@using JournalApplication.Services
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject UserSessionService UserSession

<MudThemeProvider IsDarkMode="@_isDarkMode" Theme="@_customTheme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <!-- AppBar -->
    <MudAppBar Elevation="1" Color="Color.Primary" Fixed="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="ToggleDrawer" />
        <MudText Typo="Typo.h6" Class="ml-3">Journal Application</MudText>
        <MudSpacer />
        
        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                       Color="Color.Inherit"
                       OnClick="ToggleTheme" />
                       
        <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <ActivatorContent>
                <MudChip T="string" Color="Color.Secondary" Icon="@Icons.Material.Filled.Person" Variant="Variant.Filled">
                    @(UserSession.CurrentUser?.Name ?? "User")
                </MudChip>
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem OnClick="NavigateToProfile">Profile</MudMenuItem>
                <MudMenuItem OnClick="Logout" IconColor="Color.Error">Logout</MudMenuItem>
            </ChildContent>
        </MudMenu>
    </MudAppBar>

    <!-- Sidebar -->
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2" Variant="DrawerVariant.Responsive">
        <MudDrawerHeader Class="d-flex align-center py-4">
             <MudIcon Icon="@Icons.Material.Filled.AutoGraph" Color="Color.Primary" Class="mr-2"/>
             <MudText Typo="Typo.h6"><b>Main Menu</b></MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            @foreach (var item in MenuItems)
            {
                <MudNavLink Href="@item.Route"
                            Icon="@item.Icon"
                            Match="NavLinkMatch.All">
                    @item.Title
                </MudNavLink>
            }
        </MudNavMenu>
    </MudDrawer>

    <!-- Main Content -->
    <MudMainContent Class="pt-16 px-4 pb-4">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;

    private bool _isDarkMode = false;

    private UserInfo CurrentUser = new UserInfo("Binod Thapa", "binod@gmail.com");


    private MudTheme _customTheme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#1976D2",
            Secondary = "#424242",
            AppbarBackground = "#1976D2",
        },
        PaletteDark = new PaletteDark()
        {
            Primary = "#90CAF9",
            Secondary = "#90CAF9",
            AppbarBackground = "#1E1E1E",
            Background = "#121212",
            Surface = "#1E1E1E"
        }
    };

    void ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
    }

    void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    void NavigateToProfile()
    {
        Navigation.NavigateTo("/profile");
    }

    private async void GoBack()
    {
        try
        {
            // Try to go back in browser history
            await JS.InvokeVoidAsync("history.back");
        }
        catch
        {
            // Fallback: navigate to home if history is not available
            Navigation.NavigateTo("/");
        }
    }

    void Logout()
    {
        // TODO: Implement actual logout logic
        // Clear authentication state
        // Redirect to login
        Navigation.NavigateTo("/login");
    }

    private List<MenuItem> MenuItems = new()
    {
        new MenuItem("Dashboard", "/dashboard", Icons.Material.Filled.Dashboard),
        new MenuItem("Journals", "/journals", Icons.Material.Filled.Book),
        new MenuItem("Calendar", "/calendar", Icons.Material.Filled.CalendarMonth),
    };

    public record MenuItem(string Title, string Route, string Icon);
    public record UserInfo(string Name, string Email);
}