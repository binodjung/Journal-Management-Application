@page "/journals"
@using MudBlazor

<!-- Page Title & Create Button -->
<MudGrid Class="mb-4" AlignItems="Center">
    <MudItem xs="6">
        <MudText Typo="Typo.h4">Journals</MudText>
    </MudItem>
    <MudItem xs="6" Class="d-flex justify-end">
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/journals/create">
            Create Journal
        </MudButton>
    </MudItem>
</MudGrid>

<!-- Filters inside a Card -->
<MudPaper Class="pa-3 mb-4" Elevation="1">
    <MudGrid GutterSize="2" AlignItems="Center">
        <MudItem xs="12" sm="4">
            <MudTextField @bind-Value="_search"
                          Placeholder="Search title or content..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          FullWidth="true" />
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudDateRangePicker @bind-DateRange="_dateRange"
                                Label="Date Range"
                                Class="mud-width-full" />
        </MudItem>
        <MudItem xs="12" sm="2">
            <MudSelect T="string"
                       Label="Mood"
                       @bind-Value="_selectedMood"
                       Clearable="true"
                       FullWidth="true">
                @foreach (var mood in Moods)
                {
                    <MudSelectItem Value="@mood">@mood</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="2">
            <MudSelect T="string"
                       Label="Tag"
                       @bind-Value="_selectedTag"
                       Clearable="true"
                       FullWidth="true">
                @foreach (var tag in Tags)
                {
                    <MudSelectItem Value="@tag">@tag</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
    </MudGrid>
</MudPaper>


<!-- Journals Table -->
<MudTable Items="FilteredJournals"
          Dense="true"
          Hover="true"
          Bordered="true"
          Striped="true"
          RowsPerPage="5"
          Elevation="1">

    <HeaderContent>
        <MudTh>Date</MudTh>
        <MudTh>Title</MudTh>
        <MudTh>Primary Mood</MudTh>
        <MudTh>Tags</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>

    <RowTemplate>
        <MudTd>@context.Date.ToShortDateString()</MudTd>
        <MudTd>@context.Title</MudTd>
        <MudTd>@context.PrimaryMood</MudTd>
        <MudTd>@string.Join(", ", context.Tags)</MudTd>
        <MudTd Class="d-flex gap-1">
            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="@(() => ViewJournal(context))"
                           ToolTip="View" />
            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                           Color="Color.Info"
                           Size="Size.Small"
                           OnClick="@(() => EditJournal(context))"
                           ToolTip="Edit" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           Color="Color.Error"
                           Size="Size.Small"
                           OnClick="@(() => ConfirmDeleteJournal(context))"
                           ToolTip="Delete" />
        </MudTd>
    </RowTemplate>

    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

<!-- Delete Confirmation Dialog -->
<MudDialog @bind-IsVisible="_deleteDialogVisible">
    <DialogContent>
        <MudText Typo="Typo.h6">Are you sure you want to delete this journal entry?</MudText>
    </DialogContent>
    <DialogActions >
        <MudButton Color="Color.Primary" Variant="Variant.Text" OnClick="() => _deleteDialogVisible = false">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="DeleteJournalConfirmed">Delete</MudButton>
    </DialogActions>
</MudDialog>


@code {
    string _search;
    string _selectedMood;
    string _selectedTag;
    DateRange _dateRange;

    List<string> Moods = new()
    {
        "Happy","Excited","Calm","Sad","Angry","Stressed"
    };

    List<string> Tags = new()
    {
        "Work","Health","Travel","Family","Fitness","Study"
    };

    List<JournalEntry> NewJournals = new()
    {
        new JournalEntry
        {
            Date = DateTime.Today,
            Title = "Good Day",
            Content = "Had a productive day at work",
            PrimaryMood = "Happy",
            Tags = new() { "Work" }
        },
        new JournalEntry
        {
            Date = DateTime.Today.AddDays(-1),
            Title = "Workout",
            Content = "Went to gym",
            PrimaryMood = "Excited",
            Tags = new() { "Fitness","Health" }
        },
        new JournalEntry
        {
            Date = DateTime.Today.AddDays(-2),
            Title = "Family Time",
            Content = "Visited parents",
            PrimaryMood = "Calm",
            Tags = new() { "Family" }
        }
    };

    JournalEntry _journalToDelete;
    bool _deleteDialogVisible;

    IEnumerable<JournalEntry> FilteredJournals =>
        NewJournals.Where(j =>
            (string.IsNullOrWhiteSpace(_search) ||
                j.Title.Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                j.Content.Contains(_search, StringComparison.OrdinalIgnoreCase)) &&

            (string.IsNullOrEmpty(_selectedMood) ||
                j.PrimaryMood == _selectedMood) &&

            (string.IsNullOrEmpty(_selectedTag) ||
                j.Tags.Contains(_selectedTag)) &&

            (_dateRange == null ||
                (j.Date >= _dateRange.Start && j.Date <= _dateRange.End))
        );

    void ViewJournal(JournalEntry journal)
    {
        // Redirect to journal detail page
        NavigationManager.NavigateTo($"/journals/{journal.Title.Replace(" ", "-")}");
    }

    void EditJournal(JournalEntry journal)
    {
        // Redirect to CreateJournal page with query parameter for edit
        NavigationManager.NavigateTo($"/journals/create?title={journal.Title}");
    }

    void ConfirmDeleteJournal(JournalEntry journal)
    {
        _journalToDelete = journal;
        _deleteDialogVisible = true;
    }

    void DeleteJournalConfirmed()
    {
        if (_journalToDelete != null)
        {
            NewJournals.Remove(_journalToDelete);
            _journalToDelete = null;
        }
        _deleteDialogVisible = false;
    }

    [Inject] NavigationManager NavigationManager { get; set; }

    public class JournalEntry
    {
        public DateTime Date { get; set; }
        public string Title { get; set; }
        public string Content { get; set; }
        public string PrimaryMood { get; set; }
        public List<string> Tags { get; set; }
    }
}
