@page "/journals"
@using MudBlazor
@using JournalApplication.Services
@using JournalApplication.Model
@inject IJournalService JournalService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject UserSessionService UserSession
@inject IDialogService DialogService

<MudContainer Class="mt-6">

    <!-- HEADER -->
    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudText Typo="Typo.h4">📓 Journals</MudText>

        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   StartIcon="@Icons.Material.Filled.Add"
                   Href="/journals/create">
            Create Journal
        </MudButton>
    </MudStack>

    <!-- FILTERS -->
    <MudPaper Class="pa-4 mb-4">
        <MudGrid GutterSize="3" AlignItems="End">

            <!-- SEARCH -->
            <MudItem xs="12" md="4">
                <MudTextField T="string"
                              Label="Search"
                              Placeholder="Search by title"
                              Value="_search"
                              ValueChanged="OnSearchChanged"
                              Immediate="true"
                              Clearable
                              FullWidth />
            </MudItem>

            <!-- MOOD -->
            <MudItem xs="12" md="2">
                <MudSelect T="string"
                           Label="Mood"
                           Value="_selectedMood"
                           ValueChanged="OnMoodChanged"
						   Immediate="true"
                           Clearable
                           FullWidth>
                    <MudSelectItem Value="@("Positive")">Positive</MudSelectItem>
                    <MudSelectItem Value="@("Neutral")">Neutral</MudSelectItem>
                    <MudSelectItem Value="@("Negative")">Negative</MudSelectItem>
                </MudSelect>
            </MudItem>

            <!-- TAG -->
            <MudItem xs="12" md="2">
                <MudTextField T="string"
                              Label="Tag"
                              Placeholder="e.g. work"
                              Value="_selectedTag"
                              ValueChanged="OnTagChanged"
                              Immediate="true"
                              Clearable
                              FullWidth />
            </MudItem>

            <!-- DATE RANGE -->
            <MudItem xs="12" md="3">
                <MudDateRangePicker Label="Date Range"
                                    DateRange="_dateRange"
                                    DateRangeChanged="OnDateRangeChanged"
                                    Class="mud-width-full" />
            </MudItem>

            <!-- APPLY -->
            <MudItem xs="12" md="1">
                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           FullWidth
                           OnClick="ApplyFilters">
                    Apply
                </MudButton>
            </MudItem>

        </MudGrid>
    </MudPaper>

    <!-- TABLE -->
    <MudTable Items="_journals"
              Dense
              Hover
              Bordered
              Striped
              Elevation="1">

        <HeaderContent>
            <MudTh>Date</MudTh>
            <MudTh>Title</MudTh>
            <MudTh>Mood</MudTh>
            <MudTh>Tags</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd>@context.EntryDate.ToString("dd MMM yyyy")</MudTd>
            <MudTd>@context.Title</MudTd>
            <MudTd>
                <MudChip T="string" Color="Color.Info" Size="Size.Small">
                    @context.PrimaryMood
                </MudChip>
            </MudTd>
            <MudTd>@string.Join(", ", context.Tags)</MudTd>
            <MudTd Class="d-flex gap-1">
                <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                               Color="Color.Primary"
                               OnClick="@(() => ViewJournal(context.EntryDate))" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Color="Color.Info"
                               OnClick="@(() => EditJournal(context.EntryDate))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               OnClick="@(() => ConfirmDelete(context))" />
            </MudTd>
        </RowTemplate>
    </MudTable>

    <!-- PAGINATION -->
    <MudStack Row Justify="Justify.SpaceBetween" Class="mt-4">
        <MudText Typo="Typo.body2">Page @_currentPage</MudText>

        <MudStack Row Spacing="2">
            <MudButton Disabled="@(_currentPage == 1)"
                       OnClick="PrevPage">
                Previous
            </MudButton>

            <MudButton Disabled="@(_journals.Count < _pageSize)"
                       OnClick="NextPage">
                Next
            </MudButton>
        </MudStack>
    </MudStack>

    <!-- PDF EXPORT -->
    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h6">Export Journals PDF</MudText>

        <MudGrid Class="mt-2">
            <MudItem xs="12" md="4">
                <MudDatePicker Label="From Date"
                               @bind-Date="_pdfFromDate"
                               MaxDate="DateTime.Today" />
            </MudItem>

            <MudItem xs="12" md="4">
                <MudDatePicker Label="To Date"
                               @bind-Date="_pdfToDate"
                               MaxDate="DateTime.Today" />
            </MudItem>

            <MudItem xs="12" md="4" Class="d-flex align-center">
                <MudButton Color="Color.Primary"
                           Variant="Variant.Filled"
                           Disabled="@(!_pdfFromDate.HasValue || !_pdfToDate.HasValue)"
                           OnClick="GeneratePdf"
                           StartIcon="@Icons.Material.Filled.PictureAsPdf">
                    Generate PDF
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

</MudContainer>

@* Removed Inline Delete Dialog - using DialogService instead *@

@code {

    string _search;
    string _selectedMood;
    string _selectedTag;
    DateRange _dateRange;

    List<JournalDisplayModel> _journals = new();

    int _currentPage = 1;
    int _pageSize = 5;
    int _userId => UserSession.CurrentUser?.UserId ?? 1;

    DateTime? _pdfFromDate;
    DateTime? _pdfToDate;

    protected override async Task OnInitializedAsync()
        => await LoadJournals();

    async Task LoadJournals()
    {
        var (list, _) = await JournalService.SearchJournalsAsync(
            _userId,
            _search,
            _selectedMood,
            _selectedTag,
            _dateRange?.Start,
            _dateRange?.End,
            _currentPage,
            _pageSize);

        _journals = list;
    }

    void OnSearchChanged(string value) { _search = value; ResetOthers("search"); }
    void OnMoodChanged(string value) { _selectedMood = value; ResetOthers("mood"); }
    void OnTagChanged(string value) { _selectedTag = value; ResetOthers("tag"); }
    void OnDateRangeChanged(DateRange range) { _dateRange = range; ResetOthers("date"); }

    void ResetOthers(string source)
    {
        if (source != "search") _search = null;
        if (source != "mood") _selectedMood = null;
        if (source != "tag") _selectedTag = null;
        if (source != "date") _dateRange = null;
        _currentPage = 1;
    }

    async Task ApplyFilters() => await LoadJournals();
    async Task NextPage() { _currentPage++; await LoadJournals(); }
    async Task PrevPage() { if (_currentPage > 1) _currentPage--; await LoadJournals(); }

    void ViewJournal(DateTime d) => NavigationManager.NavigateTo($"/journals/view/{d:yyyy-MM-dd}");
    void EditJournal(DateTime d) => NavigationManager.NavigateTo($"/journals/create?date={d:yyyy-MM-dd}");

    async Task ConfirmDelete(JournalDisplayModel j) 
    { 
        bool? result = await DialogService.ShowMessageBox(
            "Delete Journal", 
            "Are you sure you want to delete this journal entry?", 
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            await JournalService.DeleteJournalAsync(_userId, j.EntryDate);
            Snackbar.Add("Journal deleted successfully", Severity.Success);
            await LoadJournals();
        }
    }

    async Task GeneratePdf()
    {
        var bytes = await JournalService.GenerateJournalPdfAsync(
            _userId, _pdfFromDate!.Value, _pdfToDate!.Value);

        await JSRuntime.InvokeVoidAsync(
            "downloadFileFromBase64",
            $"journals_{_pdfFromDate:yyyyMMdd}_{_pdfToDate:yyyyMMdd}.pdf",
            Convert.ToBase64String(bytes));
    }
}
<script>
    window.downloadFileFromBase64 = (fileName, base64) => {
        const link = document.createElement("a");
        link.href = "data:application/pdf;base64," + base64;
        link.download = fileName;
        link.click();
    };
</script>