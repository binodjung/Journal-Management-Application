@page "/dashboard"
@using MudBlazor
@using JournalApplication.Services
@using JournalApplication.Model
@inject IJournalService JournalService
@inject UserSessionService UserSession

@if (_loading)
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-16 text-center">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.h6" Class="mt-4">Loading your analytics...</MudText>
    </MudContainer>
}
else
{

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <MudGrid Class="pa-4">
        <MudItem xs="12">
            <MudText Typo="Typo.h4" Class="mb-2">📊 Dashboard</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Welcome back! Here's your journaling overview.</MudText>
        </MudItem>
    </MudGrid>

<!-- Quick Stats Cards -->
<MudGrid Class="mt-6" Spacing="3">

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-5 rounded-xl" Elevation="3">
            <MudStack Spacing="1">

                <MudStack Direction="Row" class = "d-flex align-center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment"
                             Color="Color.Warning"
                             Size="Size.Medium" />
                    <MudText Typo="Typo.subtitle1">Current Streak</MudText>
                </MudStack>

                <MudText Typo="Typo.h3" Color="Color.Warning">
                    @_currentStreak
                </MudText>

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    days
                </MudText>

            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-5 rounded-xl" Elevation="3">
            <MudStack Spacing="1">

                <MudStack Direction="Row" class = "d-flex align-center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.EmojiEvents"
                             Color="Color.Success"
                             Size="Size.Medium" />
                    <MudText Typo="Typo.subtitle1">Longest Streak</MudText>
                </MudStack>

                <MudText Typo="Typo.h3" Color="Color.Success">
                    @_longestStreak
                </MudText>

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    days
                </MudText>

            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-5 rounded-xl" Elevation="3">
            <MudStack Spacing="1">

                <MudStack Direction="Row" class = "d-flex align-center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Book"
                             Color="Color.Primary"
                             Size="Size.Medium" />
                    <MudText Typo="Typo.subtitle1">Total Entries</MudText>
                </MudStack>

                <MudText Typo="Typo.h3" Color="Color.Primary">
                    @_totalEntries
                </MudText>

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    journals
                </MudText>

            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-5 rounded-xl" Elevation="3">
            <MudStack Spacing="1">

                <MudStack Direction="Row" class = "d-flex align-center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarMonth"
                             Color="Color.Error"
                             Size="Size.Medium" />
                    <MudText Typo="Typo.subtitle1">Missed Days</MudText>
                </MudStack>

                <MudText Typo="Typo.h3" Color="Color.Error">
                    @_missedDays
                </MudText>

                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    this month
                </MudText>

            </MudStack>
        </MudPaper>
    </MudItem>

</MudGrid>


<!-- Charts Section -->
<MudGrid Class="mt-4">
    <!-- Mood Distribution -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Mood Distribution</MudText>
            <MudChart ChartType="ChartType.Pie" 
                      Width="100%" 
                      Height="300px"
                      InputData="@_moodData" 
                      InputLabels="@_moodLabels">
                <CustomGraphics>
                    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="currentColor" font-size="24">
                        @_totalEntries
                    </text>
                    <text x="50%" y="55%" dominant-baseline="hanging" text-anchor="middle" fill="currentColor" font-size="12">
                        Entries
                    </text>
                </CustomGraphics>
            </MudChart>
        </MudPaper>
    </MudItem>

    <!-- Most Frequent Mood -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-6 rounded-xl" Elevation="3">
            <MudText Typo="Typo.h6" Class="mb-3">Top Moods</MudText>
            <MudChart ChartType="ChartType.Bar" 
                      Width="100%" 
                      Height="300px"
                      ChartOptions="@_chartOptions"
                      @bind-SelectedIndex="_moodIdx"
                      XAxisLabels="@_topMoodsLabels">
                <ChildContent>
                    @foreach (var mood in _topMoodsSeries)
                    {
                        <MudChartSeries Name="@mood.Name" Data="@mood.Data" />
                    }
                </ChildContent>
            </MudChart>
        </MudPaper>
    </MudItem>

    <!-- Most Used Tags -->
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-6 rounded-xl" Elevation="3">
            <MudText Typo="Typo.h6" Class="mb-3">Most Used Tags</MudText>
            <MudChart ChartType="ChartType.Bar" 
                      Width="100%" 
                      Height="300px"
                      ChartOptions="@_chartOptions"
                      XAxisLabels="@_tagLabels">
                <ChildContent>
                    @foreach (var tag in _tagSeries)
                    {
                        <MudChartSeries Name="@tag.Name" Data="@tag.Data" />
                    }
                </ChildContent>
            </MudChart>
        </MudPaper>
    </MudItem>

    <!-- Word Count Trend -->
    <MudItem xs="12" md="12">
        <MudPaper Class="pa-6 rounded-xl" Elevation="3">
            <MudText Typo="Typo.h6" Class="mb-3">Word Count Trends (Last 7 Days)</MudText>
            <MudChart ChartType="ChartType.Line" 
                      Width="100%" 
                      Height="300px"
                      ChartOptions="@_lineChartOptions"
                      XAxisLabels="@_wordCountLabels">
                <ChildContent>
                    <MudChartSeries Name="Words" Data="@_wordCountData" />
                </ChildContent>
            </MudChart>
        </MudPaper>
    </MudItem>
</MudGrid>

<!-- Recent Entries -->
<MudGrid Class="mt-4">
    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <div class="d-flex justify-space-between align-center mb-3">
                <MudText Typo="Typo.h6">Recent Entries</MudText>
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary" 
                           EndIcon="@Icons.Material.Filled.ArrowForward"
                           Href="/journals">
                    View All
                </MudButton>
            </div>
            
            <MudDivider Class="mb-3" />
            
            @foreach (var entry in _recentEntries)
            {
                <MudPaper Class="pa-3 mb-2" Elevation="0" Style="border: 1px solid var(--mud-palette-divider);">
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.subtitle1">@entry.Title</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Default">
                                @entry.EntryDate.ToString("MMM dd, yyyy")
                            </MudText>
                        </div>
                        <div class="d-flex align-center gap-2">
                            <MudChip T="string" Size="Size.Small" Color="GetMoodColor(entry.PrimaryMood)">
                                @entry.PrimaryMood
                            </MudChip>

                            <MudIconButton Icon="@Icons.Material.Filled.ArrowForward" 
                                           Size="Size.Small"
                                           OnClick="@(() => ViewEntry(entry))" />
                        </div>
                    </div>
                </MudPaper>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

</MudContainer>
}

@code {
    [Inject] NavigationManager NavigationManager { get; set; }

    // Stats
    int _currentStreak = 0;
    int _longestStreak = 0;
    int _totalEntries = 0;
    int _missedDays = 0;

    // Mood Distribution (Pie Chart)
    double[] _moodData = Array.Empty<double>();
    string[] _moodLabels = Array.Empty<string>();

    // Top Moods (Bar Chart)
    List<ChartSeries> _topMoodsSeries = new();
    string[] _topMoodsLabels = Array.Empty<string>();

    // Most Used Tags
    List<ChartSeries> _tagSeries = new();
    string[] _tagLabels = Array.Empty<string>();

    // Word Count Trends
    double[] _wordCountData = Array.Empty<double>();
    string[] _wordCountLabels = Array.Empty<string>();

    int _moodIdx = -1;

    // Chart Options
    ChartOptions _chartOptions = new()
    {
        YAxisTicks = 2,
        MaxNumYAxisTicks = 5
    };

    ChartOptions _lineChartOptions = new()
    {
        YAxisTicks = 50,
        MaxNumYAxisTicks = 6,
        LineStrokeWidth = 3
    };

    // Recent Entries
    List<JournalDisplayModel> _recentEntries = new();
    bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        
        var userId = UserSession.CurrentUser?.UserId ?? 1;
        var analytics = await JournalService.GetAnalyticsAsync(userId);

        // Map Stats
        _currentStreak = analytics.CurrentStreak;
        _longestStreak = analytics.LongestStreak;
        _totalEntries = analytics.TotalEntries;
        _missedDays = analytics.MissedDays;

        // Map Mood Distribution
        _moodData = analytics.MoodDistribution.Select(m => m.Value).ToArray();
        _moodLabels = analytics.MoodDistribution.Select(m => m.Label).ToArray();

        // Map Top Moods
        _topMoodsSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Moods", Data = analytics.TopMoods.Select(m => m.Value).ToArray() }
        };
        _topMoodsLabels = analytics.TopMoods.Select(m => m.Label).ToArray();

        // Map Tag Usage
        _tagSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Tags", Data = analytics.TagUsage.Select(t => t.Value).ToArray() }
        };
        _tagLabels = analytics.TagUsage.Select(t => t.Label).ToArray();

        // Map Word Count Trend
        _wordCountData = analytics.WordCountTrend.Select(w => w.Value).ToArray();
        _wordCountLabels = analytics.WordCountTrend.Select(w => w.Label).ToArray();

        // Map Recent Entries
        _recentEntries = analytics.RecentEntries;

        _loading = false;
        StateHasChanged();
    }

    Color GetMoodColor(string primaryMood)
    {
        var moodCategories = new Dictionary<string, List<string>>
        {
            ["Positive"] = new() { "Happy", "Excited", "Relaxed", "Grateful", "Confident" },
            ["Neutral"] = new() { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" },
            ["Negative"] = new() { "Sad", "Angry", "Stressed", "Lonely", "Anxious" }
        };

        foreach (var category in moodCategories)
        {
            if (category.Value.Contains(primaryMood))
            {
                return category.Key switch
                {
                    "Positive" => Color.Success,
                    "Neutral" => Color.Default,
                    "Negative" => Color.Error,
                    _ => Color.Default
                };
            }
        }
        return Color.Default;
    }

    void ViewEntry(JournalDisplayModel entry)
    {
        NavigationManager.NavigateTo($"/journals/view/{entry.EntryDate:yyyy-MM-dd}");
    }
}