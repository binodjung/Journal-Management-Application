@page "/journals/create"
@using MudBlazor
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudGrid Class="mb-4 mt-5 pa-4">
    <MudItem xs="12">
        <MudText Typo="Typo.h4" Class="mb-2">
            @(_isEditMode ? "Edit Journal Entry" : "Create Journal Entry")
        </MudText>
        <MudText Typo="Typo.body2">
            @DateTime.Today.ToString("dddd, MMMM dd, yyyy")
        </MudText>
    </MudItem>
</MudGrid>

<MudGrid>
    <!-- ================= MAIN FORM ================= -->
    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Elevation="2">

            <MudForm @ref="_form" @bind-IsValid="_formValid">

                <!-- Title -->
                <MudTextField @bind-Value="_title"
                              Label="Title"
                              Variant="Variant.Outlined"
                              Required
                              RequiredError="Title is required"
                              Class="mb-4" />

                <!-- Content -->
                <MudText Typo="Typo.subtitle2" Class="mb-1">Content</MudText>

                <div id="@EditorId"
                     style="height:200px; background:white; border:1px solid #ccc; border-radius:4px">
                </div>

                <!-- Primary Mood Category -->
                <MudSelect T="string"
                           @bind-Value="_primaryMoodCategory"
                           Label="Primary Mood"
                           Variant="Variant.Outlined"
                           Required
                           RequiredError="Please select a mood category"
                           Class="mb-4 mt-4">
                    <MudSelectItem Value="@("Positive")">Positive</MudSelectItem>
                    <MudSelectItem Value="@("Neutral")">Neutral</MudSelectItem>
                    <MudSelectItem Value="@("Negative")">Negative</MudSelectItem>

                </MudSelect>

                <!-- Secondary Moods -->
                @if (!string.IsNullOrEmpty(_primaryMoodCategory))
                {
                    <MudSelect T="string"
                               Label="Secondary Moods (Max 2)"
                               Variant="Variant.Outlined"
                               MultiSelection="true"
                               @bind-SelectedValues="_secondaryMoods"
                               SelectionChangedAsync="OnSecondaryMoodChanged"
                               Class="mb-4">
                        @foreach (var mood in GetMoodsByCategory(_primaryMoodCategory))
                        {
                            <MudSelectItem Value="@mood">@mood</MudSelectItem>
                        }
                    </MudSelect>
                }

                <!-- Tags -->
                <MudAutocomplete T="string"
                                 @bind-Value="_currentTag"
                                 Label="Add Tags"
                                 Variant="Variant.Outlined"
                                 SearchFunc="SearchTags"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 CoerceValue="false"
                                 AdornmentIcon="@Icons.Material.Filled.Add"
                                 OnAdornmentClick="AddTag"
                                 Class="mb-3" />

                <!-- Action Buttons -->
                <MudDivider Class="my-4" />

                <div class="d-flex justify-end gap-2">
                    <MudButton Variant="Variant.Outlined"
                               OnClick="Cancel">
                        Cancel
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveEntry"
                               Disabled="@(!_formValid || _isSaving)">

                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small"
                                                 Indeterminate
                                                 Class="mr-2" />
                        }

                        @(_isEditMode ? "Update Entry" : "Save Entry")
                    </MudButton>
                </div>

            </MudForm>
        </MudPaper>
    </MudItem>

    <!-- ================= SIDEBAR ================= -->
    <MudItem xs="12" md="4">

        <!-- Writing Tips -->
        <MudPaper Class="pa-4 mb-3" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Size="Size.Small" Class="mr-2" />
                Writing Tips
            </MudText>

            <MudList T="string" Dense>
                <MudListItem>Be honest with your feelings</MudListItem>
                <MudListItem>Include specific details</MudListItem>
                <MudListItem>Reflect on what you learned</MudListItem>
                <MudListItem>Set goals for tomorrow</MudListItem>
            </MudList>
        </MudPaper>

        <!-- Stats -->
        <MudPaper Class="pa-4 mb-3" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-2">Entry Statistics</MudText>

            <MudGrid>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2">Words</MudText>
                    <MudText Typo="Typo.h6">@GetWordCount()</MudText>
                </MudItem>

                <MudItem xs="6">
                    <MudText Typo="Typo.body2">Characters</MudText>
                    <MudText Typo="Typo.h6">@(_content?.Length ?? 0)</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Popular Tags -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Popular Tags</MudText>

            <div class="d-flex flex-wrap gap-1">
                @foreach (var tag in _preBuiltTags.Take(12))
                {
                    <MudChip T="string" Size="Size.Small"
                             Variant="Variant.Outlined"
                             OnClick="@(() => QuickAddTag(tag))">
                        @tag
                    </MudChip>
                }
            </div>
        </MudPaper>

    </MudItem>
</MudGrid>

@code {

    [Parameter]
    [SupplyParameterFromQuery(Name = "title")]
    public string ExistingTitle { get; set; }

    string EditorId = $"quill-editor-{Guid.NewGuid()}";

    MudForm _form;
    bool _formValid;
    bool _isEditMode;
    bool _isSaving;

    string _title = "";
    string _content = "";
    string _primaryMoodCategory = "";
    IEnumerable<string> _secondaryMoods = new HashSet<string>();
    string _currentTag = "";
    List<string> _selectedTags = new();

    // Mood lists
    List<string> _positiveMoods = new() { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
    List<string> _neutralMoods = new() { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" };
    List<string> _negativeMoods = new() { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };

    // Tags
    List<string> _preBuiltTags = new()
{
    "Work","Health","Travel","Family","Fitness",
    "Study","Friends","Hobby","Finance","Personal"
};

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(ExistingTitle))
        {
            _isEditMode = true;
            LoadExistingEntry();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await JS.InvokeVoidAsync("initQuill", EditorId);
    }

    void LoadExistingEntry()
    {
        _title = "Good Day at Work";
        _content = "Had a productive day at work.";
        _selectedTags = new() { "Work", "Productivity" };
    }

    List<string> GetMoodsByCategory(string category)
    {
        return category switch
        {
            "Positive" => _positiveMoods,
            "Neutral" => _neutralMoods,
            "Negative" => _negativeMoods,
            _ => new()
        };
    }

    async Task OnSecondaryMoodChanged(IEnumerable<string> values)
    {
        if (values.Count() > 2)
        {
            Snackbar.Add("You can select up to 2 secondary moods only.", Severity.Warning);
            return;
        }

        _secondaryMoods = values;
        await Task.CompletedTask;
    }

    private Task<IEnumerable<string>> SearchTags(string value, CancellationToken cancellationToken)
    {
        var tags = new List<string> { "Blazor", "C#", "MudBlazor", "Razor" };
        var filtered = tags.Where(x => string.IsNullOrEmpty(value) || x.Contains(value, StringComparison.OrdinalIgnoreCase));
        return Task.FromResult(filtered.AsEnumerable());
    }


    void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(_currentTag) &&
            !_selectedTags.Contains(_currentTag))
        {
            _selectedTags.Add(_currentTag);
            _currentTag = "";
        }
    }

    void QuickAddTag(string tag)
    {
        if (!_selectedTags.Contains(tag))
            _selectedTags.Add(tag);
    }

    int GetWordCount()
    {
        if (string.IsNullOrWhiteSpace(_content))
            return 0;

        return _content.Split(
            new[] { ' ', '\n', '\r', '\t' },
            StringSplitOptions.RemoveEmptyEntries).Length;
    }

    async Task SaveEntry()
    {
        await _form.Validate();

        if (!_formValid)
            return;

        _isSaving = true;

        await Task.Delay(1000); // simulate save

        Snackbar.Add(
            _isEditMode ? "Entry updated successfully!" : "Entry saved successfully!",
            Severity.Success);

        _isSaving = false;

        NavigationManager.NavigateTo("/journals");
    }

    void Cancel()
    {
        NavigationManager.NavigateTo("/journals");
    }
}
