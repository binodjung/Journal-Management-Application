@page "/journals/create"
@layout MainLayout

@using MudBlazor
@using JournalApplication.Model
@using JournalApplication.Services
@inject IJSRuntime JS
@inject IJournalService JournalService
@inject UserSessionService UserSession
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<MudPaper Class="pa-4 mt-6" Elevation="2">
    <MudForm @ref="_form">

        <MudText Typo="Typo.h5" Class="mb-4">
            Create Journal
        </MudText>

        <!-- TITLE -->
        <MudTextField @bind-Value="_model.Title"
                      Label="Title"
                      Required="true"
                      RequiredError="Title is required"
                      MaxLength="100" />

        <!-- CONTENT -->
        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-1">
            Content
        </MudText>

        <div id="@EditorId"
             style="height:220px; background:white; border:1px solid #ccc; border-radius:6px">
        </div>

        <!-- PRIMARY MOOD -->
        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">
            Primary Mood (Required)
        </MudText>

        <MudSelect T="string"
                   Label="Select Category First"
                   @bind-Value="_selectedCategory"
                   Required="true"
                   Class="mb-3">
            <MudSelectItem T="string" Value="@("Positive")">Positive</MudSelectItem>
            <MudSelectItem T="string" Value="@("Neutral")">Neutral</MudSelectItem>
            <MudSelectItem T="string" Value="@("Negative")">Negative</MudSelectItem>
        </MudSelect>

        @if (!string.IsNullOrEmpty(_selectedCategory))
        {
            <MudSelect T="string"
                       Label="Primary Mood"
                       Required="true"
                       RequiredError="Primary mood is required"
                       @bind-Value="_model.PrimaryMood">
                @foreach (var mood in GetMoodsForCategory(_selectedCategory))
                {
                    <MudSelectItem T="string" Value="@mood">@mood</MudSelectItem>
                }
            </MudSelect>
        }

        <!-- SECONDARY MOODS -->
        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">
            Secondary Moods (Optional - Max 2)
        </MudText>

        <MudSelect T="string"
                   Label="Secondary Moods"
                   MultiSelection="true"
                   SelectedValues="_secondaryMoods"
                   SelectedValuesChanged="OnSecondaryMoodsChanged">
            <MudSelectItem T="string" Disabled="true">
                <MudText Typo="Typo.caption" Color="Color.Primary">Positive</MudText>
            </MudSelectItem>
            @foreach (var mood in PositiveMoods)
            {
                <MudSelectItem T="string" Value="@mood">@mood</MudSelectItem>
            }
            <MudSelectItem T="string" Disabled="true">
                <MudText Typo="Typo.caption" Color="Color.Info">Neutral</MudText>
            </MudSelectItem>
            @foreach (var mood in NeutralMoods)
            {
                <MudSelectItem T="string" Value="@mood">@mood</MudSelectItem>
            }
            <MudSelectItem T="string" Disabled="true">
                <MudText Typo="Typo.caption" Color="Color.Warning">Negative</MudText>
            </MudSelectItem>
            @foreach (var mood in NegativeMoods)
            {
                <MudSelectItem T="string" Value="@mood">@mood</MudSelectItem>
            }
        </MudSelect>

        @if (_secondaryMoods.Count > 0)
        {
            <MudText Typo="Typo.caption" Class="mt-1">
                Selected: @string.Join(", ", _secondaryMoods)
            </MudText>
        }

        <!-- TAGS -->
        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">
            Tags (Optional)
        </MudText>

        <MudSelect T="string"
                   Label="Select Tags"
                   MultiSelection="true"
                   SelectedValues="_selectedTags"
                   SelectedValuesChanged="OnTagsChanged">
            @foreach (var tag in PredefinedTags)
            {
                <MudSelectItem T="string" Value="@tag">@tag</MudSelectItem>
            }
        </MudSelect>

        @if (_selectedTags.Count > 0)
        {
            <MudText Typo="Typo.caption" Class="mt-1">
                Selected Tags: @string.Join(", ", _selectedTags)
            </MudText>
        }

        <MudText Typo="Typo.caption" Color="Color.Error" Class="mt-2">
            @_formMessage
        </MudText>

        <!-- ACTIONS -->
        <div class="mt-4">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">
                Save Journal
            </MudButton>

            <MudButton Class="ml-2" Variant="Variant.Outlined" OnClick="Cancel">
                Cancel
            </MudButton>
        </div>

    </MudForm>
</MudPaper>

@code {

    private MudForm? _form;
    private string _formMessage = "";

    private JournalViewModel _model = new()
    {
        EntryDate = DateTime.Today
    };

    private string EditorId = $"quill-editor-{Guid.NewGuid()}";

    private string _selectedCategory = "";
    private HashSet<string> _secondaryMoods = new();
    private HashSet<string> _selectedTags = new();

    // Mood Categories
    private readonly string[] PositiveMoods =
    {
        "Happy", "Excited", "Relaxed", "Grateful", "Confident"
    };

    private readonly string[] NeutralMoods =
    {
        "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored"
    };

    private readonly string[] NegativeMoods =
    {
        "Sad", "Angry", "Stressed", "Lonely", "Anxious"
    };

    // Predefined Tags
    private readonly string[] PredefinedTags =
    {
        "Work", "Career", "Studies", "Family", "Friends", "Relationships",
        "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies",
        "Travel", "Nature", "Finance", "Spirituality", "Birthday",
        "Holiday", "Vacation", "Celebration", "Exercise", "Reading",
        "Writing", "Cooking", "Meditation", "Yoga", "Music", "Shopping",
        "Parenting", "Projects", "Planning", "Reflection"
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initQuill", EditorId);
        }
    }

    private string[] GetMoodsForCategory(string category)
    {
        return category switch
        {
            "Positive" => PositiveMoods,
            "Neutral" => NeutralMoods,
            "Negative" => NegativeMoods,
            _ => Array.Empty<string>()
        };
    }

    private void OnSecondaryMoodsChanged(IEnumerable<string> values)
    {
        var list = values.Where(v => !string.IsNullOrEmpty(v)).ToList();

        if (list.Count > 2)
        {
            // Keep only the last 2 selected
            list = list.TakeLast(2).ToList();
            Snackbar.Add("Maximum 2 secondary moods allowed", Severity.Warning);
        }

        _secondaryMoods = list.ToHashSet();
        _model.SecondaryMoods = _secondaryMoods.ToList();
    }

    private void OnTagsChanged(IEnumerable<string> values)
    {
        _selectedTags = values.ToHashSet();
        _model.Tags = _selectedTags.ToList();
    }

    private async Task Save()
    {
        await _form!.Validate();
        if (!_form.IsValid)
        {
            _formMessage = "Please fill all required fields.";
            return;
        }

        if (!UserSession.IsLoggedIn)
        {
            _formMessage = "You must be logged in.";
            return;
        }

        // Get content from Quill editor
        _model.Content = await JS.InvokeAsync<string>("getQuillHtml");

        // Validate content
        if (string.IsNullOrWhiteSpace(_model.Content))
        {
            _formMessage = "Content is required.";
            return;
        }

        var userId = UserSession.CurrentUser!.UserId;

        var result = await JournalService.AddOrUpdateJournalAsync(userId, _model);

        if (result.Success)
        {
            Snackbar.Add("Journal saved successfully!", Severity.Success);
            Navigation.NavigateTo("/journals");
        }
        else
        {
            _formMessage = result.ErrorMessage ?? "Error saving journal.";
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/journals");
    }
}
