@page "/journals/create"
@using MudBlazor

<MudGrid>
    <MudItem xs="12">
        <MudText Typo="Typo.h4" Class="mb-2">@(_isEditMode ? "Edit Journal Entry" : "Create Journal Entry")</MudText>
        <MudText Typo="Typo.body2" Color="Color.Default">
            @DateTime.Today.ToString("dddd, MMMM dd, yyyy")
        </MudText>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-4">
    <MudItem xs="12" md="8">
        <MudPaper Class="pa-4" Elevation="2">
            <MudForm @ref="_form" @bind-IsValid="@_formValid">
                <!-- Title -->
                <MudTextField @bind-Value="_title"
                              Label="Title"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="Title is required"
                              Class="mb-4"
                              HelperText="Give your entry a meaningful title" />

                <!-- Content -->
                <MudTextField @bind-Value="_content"
                              Label="Content"
                              Variant="Variant.Outlined"
                              Lines="12"
                              Required="true"
                              RequiredError="Content is required"
                              Class="mb-4"
                              HelperText="Write your thoughts, experiences, or reflections" />

                <!-- Primary Mood -->
                <MudSelect @bind-Value="_primaryMood"
                           Label="Primary Mood"
                           Variant="Variant.Outlined"
                           Required="true"
                           RequiredError="Please select your primary mood"
                           Class="mb-4"
                           AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("")" Disabled="true">-- Select Mood --</MudSelectItem>
                    <MudText Typo="Typo.caption" Class="px-4 pt-2" Style="color: var(--mud-palette-success);">Positive</MudText>
                    @foreach (var mood in _positiveMoods)
                    {
                        <MudSelectItem Value="@mood">@mood</MudSelectItem>
                    }
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.caption" Class="px-4" Style="color: var(--mud-palette-text-secondary);">Neutral</MudText>
                    @foreach (var mood in _neutralMoods)
                    {
                        <MudSelectItem Value="@mood">@mood</MudSelectItem>
                    }
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.caption" Class="px-4" Style="color: var(--mud-palette-error);">Negative</MudText>
                    @foreach (var mood in _negativeMoods)
                    {
                        <MudSelectItem Value="@mood">@mood</MudSelectItem>
                    }
                </MudSelect>

                <!-- Secondary Moods -->
                <MudSelect @bind-Value="_secondaryMood1"
                           Label="Secondary Mood 1 (Optional)"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           Class="mb-4"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var mood in _allMoods)
                    {
                        <MudSelectItem Value="@mood">@mood</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect @bind-Value="_secondaryMood2"
                           Label="Secondary Mood 2 (Optional)"
                           Variant="Variant.Outlined"
                           Clearable="true"
                           Class="mb-4"
                           AnchorOrigin="Origin.BottomCenter">
                    @foreach (var mood in _allMoods)
                    {
                        <MudSelectItem Value="@mood">@mood</MudSelectItem>
                    }
                </MudSelect>

                <!-- Tags -->
                <MudAutocomplete T="string"
                                 @bind-Value="_currentTag"
                                 Label="Add Tags"
                                 Variant="Variant.Outlined"
                                 SearchFunc="@SearchTags"
                                 ResetValueOnEmptyText="true"
                                 CoerceText="true"
                                 CoerceValue="false"
                                 AdornmentIcon="@Icons.Material.Filled.Add"
                                 OnAdornmentClick="AddTag"
                                 Class="mb-2"
                                 HelperText="Type and press Enter or click + to add tags" />

                <!-- Selected Tags -->
                @if (_selectedTags.Any())
                {
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        @foreach (var tag in _selectedTags)
                        {
                            <MudChip T="string" Size="Size.Small"
                                     Color="Color.Primary"
                                     OnClose="@(() => RemoveTag(tag))">
                                @tag
                            </MudChip>
                        }
                    </div>
                }

                <!-- Action Buttons -->
                <MudDivider Class="my-4" />
                
                <div class="d-flex gap-2 justify-end">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               OnClick="Cancel">
                        Cancel
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="SaveEntry"
                               Disabled="@(!_formValid || _isSaving)">
                        @if (_isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        @(_isEditMode ? "Update Entry" : "Save Entry")
                    </MudButton>
                </div>
            </MudForm>
        </MudPaper>
    </MudItem>

    <!-- Sidebar with Tips and Stats -->
    <MudItem xs="12" md="4">
        <!-- Writing Tips -->
        <MudPaper Class="pa-4 mb-3" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Lightbulb" Size="Size.Small" Class="mr-2" />
                Writing Tips
            </MudText>
            <MudList T="string" Dense="true">
                <MudListItem Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Be honest with your feelings</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Include specific details</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Reflect on what you learned</MudText>
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Circle" IconSize="Size.Small">
                    <MudText Typo="Typo.body2">Set goals for tomorrow</MudText>
                </MudListItem>
            </MudList>
        </MudPaper>

        <!-- Word Count -->
        <MudPaper Class="pa-4 mb-3" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-2">Entry Statistics</MudText>
            <MudGrid Spacing="1">
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Default">Words:</MudText>
                    <MudText Typo="Typo.h6">@GetWordCount()</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Default">Characters:</MudText>
                    <MudText Typo="Typo.h6">@(_content?.Length ?? 0)</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Available Tags -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Popular Tags</MudText>
            <div class="d-flex flex-wrap gap-1">
                @foreach (var tag in _preBuiltTags.Take(12))
                {
                    <MudChip T="string" Size="Size.Small"
                             Variant="Variant.Outlined"
                             OnClick="@(() => QuickAddTag(tag))">
                        @tag
                    </MudChip>
                }
            </div>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Inject] NavigationManager NavigationManager { get; set; }
    [Inject] ISnackbar Snackbar { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "title")]
    public string ExistingTitle { get; set; }

    MudForm _form;
    bool _formValid;
    bool _isEditMode = false;
    bool _isSaving = false;

    string _title = "";
    string _content = "";
    string _primaryMood = "";
    string _secondaryMood1 = "";
    string _secondaryMood2 = "";
    string _currentTag = "";
    List<string> _selectedTags = new();

    // Mood categories
    List<string> _positiveMoods = new() { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
    List<string> _neutralMoods = new() { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" };
    List<string> _negativeMoods = new() { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };
    List<string> _allMoods = new();

    // Pre-built tags
    List<string> _preBuiltTags = new()
    {
        "Work", "Career", "Studies", "Family", "Friends", "Relationships",
        "Health", "Fitness", "Personal Growth", "Self-care", "Hobbies", "Travel",
        "Nature", "Finance", "Spirituality", "Birthday", "Holiday", "Vacation",
        "Celebration", "Exercise", "Reading", "Writing", "Cooking", "Meditation",
        "Yoga", "Music", "Shopping", "Parenting", "Projects", "Planning", "Reflection"
    };

    protected override void OnInitialized()
    {
        _allMoods.AddRange(_positiveMoods);
        _allMoods.AddRange(_neutralMoods);
        _allMoods.AddRange(_negativeMoods);

        // Check if editing existing entry
        if (!string.IsNullOrEmpty(ExistingTitle))
        {
            _isEditMode = true;
            LoadExistingEntry();
        }
    }

    void LoadExistingEntry()
    {
        // TODO: Load from database
        // Mock data for demonstration
        _title = "Good Day at Work";
        _content = "Had a productive day at work. Completed all my tasks and felt accomplished. Looking forward to tomorrow's challenges.";
        _primaryMood = "Happy";
        _secondaryMood1 = "Confident";
        _selectedTags = new() { "Work", "Productivity" };
    }

    async Task<IEnumerable<string>> SearchTags(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return _preBuiltTags;

        return _preBuiltTags.Where(t => t.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(_currentTag) && !_selectedTags.Contains(_currentTag))
        {
            _selectedTags.Add(_currentTag);
            _currentTag = "";
        }
    }

    void QuickAddTag(string tag)
    {
        if (!_selectedTags.Contains(tag))
        {
            _selectedTags.Add(tag);
        }
    }

    void RemoveTag(string tag)
    {
        _selectedTags.Remove(tag);
    }

    int GetWordCount()
    {
        if (string.IsNullOrWhiteSpace(_content))
            return 0;

        return _content.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    async Task SaveEntry()
    {
        await _form.Validate();

        if (!_formValid)
            return;

        _isSaving = true;

        // Simulate API call
        await Task.Delay(1000);

        // TODO: Save to database
        // SaveToDatabase();

        Snackbar.Add(_isEditMode ? "Entry updated successfully!" : "Entry saved successfully!", Severity.Success);

        _isSaving = false;

        // Redirect to journals list
        NavigationManager.NavigateTo("/journals");
    }

    void Cancel()
    {
        NavigationManager.NavigateTo("/journals");
    }
}